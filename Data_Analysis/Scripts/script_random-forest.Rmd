---
title: "Random Forest Plot"
author: "Narbona Sabaté, L."
output: html_notebook
---

#Load dataset and libraries
```{r}
# Load the dataset
DataTot <- read.delim('Data/10_calls_metrics.txt')

# load the libraries
library(randomForest)
library(VSURF)
library(rpart)
library(rpart.plot)
library(ggplot2)
library(cowplot)
```

#Create the used Datasets
```{r}
#Dataset with the explicative data
explicative_columns <- c("preda","loca","dis","Predator","Height_model","Height_ind","Num_ind","Num_In","Num_Jv","Num_Sb","Jv_fem","Sb_fem","Ad_fem","Paired_Ad","Non_paried_Ad")
Data_ctxt_excecpt_group_ind <- DataTot[, explicative_columns]


#Data_ctxt_excecpt_group_ind[explicative_columns] <- lapply(Data_ctxt_excecpt_group_ind[explicative_columns], factor)#convert all columns into factors

#Dataset with only the metrics
Data_metrics <- DataTot 
Data_metrics[, c("seqID", "Name_seq","group","ind","preda","loca","dis","Predator","Height_model",
            "Height_ind","Num_ind","Num_In","Num_Jv","Num_Sb","Jv_fem","Sb_fem","Ad_fem",
            "Paired_Ad","Non_paried_Ad", "propB")] <- NULL
```

#Definition of the Random Forest function 
```{r}
random_forest <- function(variabl, dataset = Data_ctxt_excecpt_group_ind){
  #Add the variable to explain
  Data_ctxt_excecpt_group_ind$VAR <- DataTot[,variabl]

  # Sélection des variables (peut prendre plusieurs minutes)
  set.seed(123)
  Vyield <- VSURF(VAR ~ ., data = Data_ctxt_excecpt_group_ind, na.action = na.omit) 
  summary(Vyield)

  # list of "prediction stpe" selected variables (column number, the predicted variable is not taken into account)
  Vyield$varselect.pred 

  # Création d'une Random Forest avec les variable sélectionnées, pour pouvoir obtenir le "% var explained"
  (fit <- randomForest(VAR ~., data = Data_ctxt_excecpt_group_ind, na.action = na.omit,
                      importance=TRUE))
  impToPlot <- importance(fit)
  png(filename=sprintf("%s percentage Variable explained.png", variabl))
  dotchart(sort(impToPlot[,1]), xlim=c(0,30), xlab="%IncMSE", main="TITLE") # 500x450
  dev.off()
  
  # Création d'un arbre de décision, avec les variables sélectionnées par VSURF
  
  YieldRT <- rpart(VAR ~., data = Data_ctxt_excecpt_group_ind)
  png(filename=sprintf("%s for first 10 calls.png", variabl))
  prp(YieldRT, box.palette = "Greens", extra=1, varlen=0, main = sprintf("%s", variabl)) #850x700
  dev.off()
}

```

#Application of the function over all metrics of the sequences
```{r}
random_forest("gramme.BB")

#for (variabl in names(Data_metrics)){
#  random_forest(variabl)
#}
```